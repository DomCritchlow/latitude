<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your Latitude</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { 
      height: 100%; background: #0a0a0b; font-family: system-ui; overflow: hidden;
      -webkit-tap-highlight-color: transparent;
      touch-action: pan-x;
    }
    #map { width: 100%; height: 100%; }
    .leaflet-control-attribution { display: none; }
    .ui {
      position: fixed; bottom: max(2rem, env(safe-area-inset-bottom, 0px)); 
      left: 50%; transform: translateX(-50%);
      z-index: 1000; display: flex; gap: 0.75rem; align-items: center;
      padding: 0 1rem;
    }
    .ui input, .ui button {
      background: rgba(10,10,11,0.85); backdrop-filter: blur(12px);
      border: 1px solid #333; color: #fafafa; border-radius: 8px;
    }
    .input-group {
      display: flex; align-items: stretch;
      background: rgba(10,10,11,0.85); backdrop-filter: blur(12px);
      border: 1px solid #333; border-radius: 12px; overflow: hidden;
    }
    .input-group input {
      font: inherit; font-size: clamp(1.5rem,6vw,2rem);
      padding: 0.5em; width: 5em; text-align: center; outline: none;
      background: transparent; border: none; color: #fafafa;
      -webkit-appearance: none;
    }
    .arrows {
      display: flex; flex-direction: column; border-left: 1px solid #333;
    }
    .arrows button {
      flex: 1; padding: 0 1em; font-size: 1.2rem;
      background: transparent; border: none; border-radius: 0;
      color: #888; cursor: pointer; width: auto; min-height: 44px;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .arrows button:hover, .arrows button:active { color: #fafafa; background: rgba(255,255,255,0.15); }
    .arrows button:first-child { border-bottom: 1px solid #333; }
    .ui > button {
      font-size: 1.5rem; min-width: 56px; min-height: 56px;
      border-radius: 50%; cursor: pointer;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .ui > button:active { background: rgba(255,255,255,0.15); }
    .center-dot {
      position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
      width: 12px; height: 12px; background: #fafafa;
      border: 2px solid #333; border-radius: 50%;
      box-shadow: 0 0 8px rgba(0,0,0,0.5);
      z-index: 1000; pointer-events: none;
    }
    .dot {
      width: 16px; height: 16px; background: #ff3b30;
      border: 2px solid #fff; border-radius: 50%;
      box-shadow: 0 0 12px rgba(255,59,48,0.8);
    }
    .loading {
      position: fixed; top: 1rem; left: 50%; transform: translateX(-50%);
      z-index: 1000; background: rgba(10,10,11,0.85); backdrop-filter: blur(12px);
      padding: 0.5rem 1rem; border-radius: 6px; font-size: 0.85rem; color: #888;
    }
    .legend {
      position: fixed; top: 1rem; right: 1rem; z-index: 1000;
      background: rgba(10,10,11,0.85); backdrop-filter: blur(12px);
      padding: 0.75rem 1rem; border-radius: 8px; font-size: 0.75rem; color: #888;
    }
    .legend span { color: #fafafa; }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="loading" id="loading" style="display:none">Loading temperatures...</div>
  <div class="legend" id="legend" style="display:none">
    <div>‚äô <span id="centerLon">‚Äî</span></div>
    <div style="margin-top:0.5rem">üìç <span id="baseTemp">‚Äî</span> here</div>
    <div>‚Üë <span id="maxTemp">‚Äî</span> warmest</div>
    <div>‚Üì <span id="minTemp">‚Äî</span> coldest</div>
  </div>
  <div class="center-dot"></div>
  <div class="ui">
    <div class="input-group">
      <input type="text" id="lat" placeholder="52.52¬∞">
      <div class="arrows">
        <button id="up">‚Üë</button>
        <button id="down">‚Üì</button>
      </div>
    </div>
    <button id="loc">üìç</button>
  </div>
  <script>
    const Z = 5;
    let lat = 52.52, marker, line, tempLayers = [];
    
    const map = L.map('map', {
      zoomControl: false, attributionControl: false,
      zoom: Z, minZoom: Z, maxZoom: Z,
      scrollWheelZoom: false, doubleClickZoom: false, touchZoom: false, boxZoom: false
    }).setView([lat, 13.4], Z);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      subdomains: 'abcd'
    }).addTo(map);
    
    const icon = L.divIcon({ className: 'dot', iconSize: [16,16], iconAnchor: [8,8] });
    
    map.on('drag', () => map.panTo([lat, map.getCenter().lng], { animate: false }));
    
    function updateCenterLon() {
      const lon = map.getCenter().lng;
      // Normalize to -180 to 180
      const normLon = ((lon + 180) % 360 + 360) % 360 - 180;
      const dir = normLon >= 0 ? 'E' : 'W';
      document.getElementById('centerLon').textContent = `${Math.abs(normLon).toFixed(2)}¬∞ ${dir}`;
    }
    
    map.on('move', updateCenterLon);
    
    async function fetchTemperatures(lat) {
      const points = [];
      // Sample every 15¬∞ longitude = 24 points around the world
      for (let lon = -180; lon < 180; lon += 15) {
        points.push({ lat, lon });
      }
      
      // Open-Meteo allows batch requests
      const lats = points.map(p => p.lat).join(',');
      const lons = points.map(p => p.lon).join(',');
      
      try {
        const res = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${lats}&longitude=${lons}&current=temperature_2m`
        );
        const data = await res.json();
        
        // Handle both single and multiple results
        if (Array.isArray(data)) {
          return points.map((p, i) => ({
            ...p,
            temp: data[i]?.current?.temperature_2m ?? null
          }));
        } else {
          return [{ ...points[0], temp: data?.current?.temperature_2m ?? null }];
        }
      } catch (e) {
        console.error('Failed to fetch temperatures:', e);
        return points.map(p => ({ ...p, temp: null }));
      }
    }
    
    function drawTemperatureLine(lat, tempData, userLon) {
      // Clear old layers
      tempLayers.forEach(l => map.removeLayer(l));
      tempLayers = [];
      
      const validTemps = tempData.filter(d => d.temp !== null);
      if (validTemps.length === 0) return;
      
      // Find temperature at user's location (closest point)
      const userPoint = validTemps.reduce((closest, d) => 
        Math.abs(d.lon - userLon) < Math.abs(closest.lon - userLon) ? d : closest
      );
      const baselineTemp = userPoint.temp;
      
      const minT = Math.min(...validTemps.map(d => d.temp));
      const maxT = Math.max(...validTemps.map(d => d.temp));
      
      // Update legend
      document.getElementById('legend').style.display = 'block';
      document.getElementById('maxTemp').textContent = `${maxT.toFixed(1)}¬∞C`;
      document.getElementById('minTemp').textContent = `${minT.toFixed(1)}¬∞C`;
      document.getElementById('baseTemp').textContent = `${baselineTemp.toFixed(1)}¬∞C`;
      
      // Scale: 1¬∞C = 0.1¬∞ latitude offset
      const scale = 0.1;
      
      // Build points with offsets
      const points = tempData.map(d => ({
        lat: lat + (d.temp !== null ? (d.temp - baselineTemp) * scale : 0),
        lon: d.lon,
        temp: d.temp,
        isWarm: d.temp !== null && d.temp >= baselineTemp
      }));
      
      // Draw segments between points with appropriate colors
      for (let w = -2; w <= 2; w++) {
        for (let i = 0; i < points.length; i++) {
          const p1 = points[i];
          const p2 = points[(i + 1) % points.length];
          const avgWarm = p1.isWarm || p2.isWarm;
          
          const segment = L.polyline([
            [p1.lat, p1.lon + w * 360],
            [p2.lat, p2.lon + w * 360 + (i === points.length - 1 ? 360 : 0)]
          ], {
            color: avgWarm ? '#ff3b30' : '#3b82f6',
            weight: 1.5,
            opacity: 0.9
          }).addTo(map);
          tempLayers.push(segment);
        }
      }
      
      // Add temperature labels at each point
      for (let w = -1; w <= 1; w++) {
        points.forEach(p => {
          if (p.temp === null) return;
          const label = L.divIcon({
            className: 'temp-label',
            html: `<span style="
              color: ${p.isWarm ? '#ff3b30' : '#3b82f6'};
              font-size: 10px;
              font-weight: 500;
              text-shadow: 0 0 3px #0a0a0b, 0 0 6px #0a0a0b;
            ">${Math.round(p.temp)}¬∞</span>`,
            iconSize: [30, 16],
            iconAnchor: [15, -4]
          });
          const m = L.marker([p.lat, p.lon + w * 360], { icon: label }).addTo(map);
          tempLayers.push(m);
        });
      }
    }
    
    async function go(newLat, lon) {
      lat = Math.max(-85, Math.min(85, newLat));
      lon = lon ?? map.getCenter().lng;
      map.setView([lat, lon], Z);
      
      if (line) map.removeLayer(line);
      line = L.polyline([[lat,-1800],[lat,1800]], { color:'#888', weight:2, opacity:0.5 }).addTo(map);
      
      marker ? marker.setLatLng([lat,lon]) : marker = L.marker([lat,lon], {icon}).addTo(map);
      document.getElementById('lat').value = `${lat.toFixed(2)}¬∞`;
      document.getElementById('legend').style.display = 'block';
      updateCenterLon();
      history.replaceState(null, '', `?lat=${lat}`);
      
      // Fetch and draw temperatures
      document.getElementById('loading').style.display = 'block';
      const temps = await fetchTemperatures(lat);
      document.getElementById('loading').style.display = 'none';
      drawTemperatureLine(lat, temps, lon);
    }
    
    document.getElementById('lat').addEventListener('change', e => {
      const v = parseFloat(e.target.value.replace(/[¬∞NSns]/gi, ''));
      if (!isNaN(v) && v >= -90 && v <= 90) go(v);
    });
    
    document.getElementById('loc').onclick = () => 
      navigator.geolocation.getCurrentPosition(p => go(p.coords.latitude, p.coords.longitude));
    
    document.getElementById('up').onclick = () => go(lat + 5);
    document.getElementById('down').onclick = () => go(lat - 5);
    
    go(parseFloat(new URLSearchParams(location.search).get('lat')) || 52.52, 13.4);
  </script>
</body>
</html>
