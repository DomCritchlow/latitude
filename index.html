<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Latitude</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { 
      height: 100%; 
      background: #0a0a0b; 
      font-family: system-ui; 
      overflow: hidden;
      -webkit-tap-highlight-color: transparent;
    }
    #map { width: 100%; height: 100%; }
    .leaflet-control-attribution { display: none; }
    
    .pill {
      background: rgba(10,10,11,0.9);
      backdrop-filter: blur(12px);
      border: 1px solid #333;
      border-radius: 50px;
      padding: 0.9rem 1.5rem;
      font-size: 1rem;
      font-weight: 500;
      letter-spacing: 0.01em;
      color: #fafafa;
      box-shadow: 0 2px 12px rgba(0,0,0,0.3);
      white-space: nowrap;
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    
    .ui {
      position: fixed;
      bottom: max(2rem, env(safe-area-inset-bottom, 0px)); 
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      gap: 0.5rem;
    }
    .ui button {
      flex: 1;
      justify-content: center;
      cursor: pointer;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      transition: all 0.15s ease;
    }
    .ui button:hover { background: rgba(30,30,32,0.95); border-color: #444; }
    .ui button:active { transform: scale(0.96); }
    
    .legend .row, .ui, .legend .pill.coords { width: 340px; }
    .legend .row .pill, .ui button { flex: 1; justify-content: center; min-width: 0; }
    
    .legend {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 0.5rem;
    }
    .legend .row { display: flex; gap: 0.5rem; }
    .legend .pill { color: #888; }
    .legend .pill span { color: #fafafa; }
    .legend .pill.coords { justify-content: center; }
    .legend .pill.warm span { color: #ff3b30; }
    .legend .pill.cold span { color: #3b82f6; }
    .legend .pill.current { border-color: #555; box-shadow: 0 0 12px rgba(250,250,250,0.15); }
    
    .center-dot {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 12px;
      height: 12px;
      background: #fafafa;
      border: 2px solid #333;
      border-radius: 50%;
      box-shadow: 0 0 8px rgba(0,0,0,0.5);
      z-index: 1000;
      pointer-events: none;
    }
    .dot {
      width: 16px;
      height: 16px;
      background: #ff3b30;
      border: 2px solid #fff;
      border-radius: 50%;
      box-shadow: 0 0 12px rgba(255,59,48,0.8);
    }
    
    .loading {
      position: fixed;
      top: 1rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 1001;
      background: rgba(10,10,11,0.85);
      backdrop-filter: blur(12px);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.85rem;
      color: #888;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div class="loading" id="loading" style="display:none">Loading temperatures...</div>
  
  <div class="legend" id="legend">
    <div class="pill coords">‚äô <span id="centerLat">‚Äî</span>, <span id="centerLon">‚Äî</span></div>
    <div class="row">
      <div class="pill cold">‚Üì <span id="minTemp">‚Äî</span></div>
      <div class="pill current">üìç <span id="baseTemp">‚Äî</span></div>
      <div class="pill warm">‚Üë <span id="maxTemp">‚Äî</span></div>
    </div>
  </div>
  
  <div class="center-dot"></div>
  
  <div class="ui">
    <button class="pill" id="unit">¬∞C</button>
    <button class="pill" id="loc">‚åñ Me</button>
    <button class="pill" id="set">‚äô Set</button>
  </div>
  
  <script>
    const Z = 5;
    let lat = 52.52, marker, line, tempLayers = [];
    let useFahrenheit = false;
    let lastTempData = null, lastUserLon = null;
    
    const toF = c => c * 9/5 + 32;
    const formatTemp = (c, showUnit = true) => {
      const val = useFahrenheit ? toF(c) : c;
      return showUnit ? `${val.toFixed(1)}${useFahrenheit ? '¬∞F' : '¬∞C'}` : Math.round(val);
    };
    
    const map = L.map('map', {
      zoomControl: false,
      attributionControl: false,
      zoom: Z, minZoom: Z, maxZoom: Z,
      scrollWheelZoom: false,
      doubleClickZoom: false,
      touchZoom: false,
      boxZoom: false
    }).setView([lat, 13.4], Z);
    
    L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
      subdomains: 'abcd'
    }).addTo(map);
    
    const icon = L.divIcon({ className: 'dot', iconSize: [16,16], iconAnchor: [8,8] });
    
    function updateCoords() {
      const { lat: latVal, lng: lonVal } = map.getCenter();
      const normLon = ((lonVal + 180) % 360 + 360) % 360 - 180;
      document.getElementById('centerLat').textContent = `${Math.abs(latVal).toFixed(2)}¬∞ ${latVal >= 0 ? 'N' : 'S'}`;
      document.getElementById('centerLon').textContent = `${Math.abs(normLon).toFixed(2)}¬∞ ${normLon >= 0 ? 'E' : 'W'}`;
    }
    map.on('move', updateCoords);
    
    async function fetchTemperatures(lat, centerLon) {
      const points = [];
      for (let offset = -180; offset < 180; offset += 5) {
        const drawLon = centerLon + offset;
        const apiLon = ((drawLon + 180) % 360 + 360) % 360 - 180;
        points.push({ lat, apiLon, drawLon });
      }
      
      try {
        const res = await fetch(
          `https://api.open-meteo.com/v1/forecast?latitude=${points.map(p => p.lat).join(',')}&longitude=${points.map(p => p.apiLon).join(',')}&current=temperature_2m`
        );
        const data = await res.json();
        return Array.isArray(data) 
          ? points.map((p, i) => ({ ...p, temp: data[i]?.current?.temperature_2m ?? null }))
          : [{ ...points[0], temp: data?.current?.temperature_2m ?? null }];
      } catch (e) {
        console.error('Failed to fetch temperatures:', e);
        return points.map(p => ({ ...p, temp: null }));
      }
    }
    
    function drawTemperatureLine(lat, tempData, userLon) {
      lastTempData = tempData;
      lastUserLon = userLon;
      
      tempLayers.forEach(l => map.removeLayer(l));
      tempLayers = [];
      
      const validTemps = tempData.filter(d => d.temp !== null);
      if (!validTemps.length) return;
      
      const centerPoint = validTemps.find(d => Math.abs(d.drawLon - userLon) < 1) || validTemps[Math.floor(validTemps.length / 2)];
      const baselineTemp = centerPoint.temp;
      const minT = Math.min(...validTemps.map(d => d.temp));
      const maxT = Math.max(...validTemps.map(d => d.temp));
      
      document.getElementById('baseTemp').textContent = formatTemp(baselineTemp);
      document.getElementById('maxTemp').textContent = formatTemp(maxT);
      document.getElementById('minTemp').textContent = formatTemp(minT);
      
      const scale = 0.1;
      const points = tempData.map(d => {
        const diff = d.temp !== null ? d.temp - baselineTemp : 0;
        return { lat: lat + diff * scale, lon: d.drawLon, temp: d.temp, diff };
      });
      
      for (let i = 0; i < points.length - 1; i++) {
        const p1 = points[i], p2 = points[i + 1];
        const avgDiff = (p1.diff + p2.diff) / 2;
        const color = avgDiff > 0 ? '#ff3b30' : '#3b82f6';
        
        tempLayers.push(L.polygon([
          [p1.lat, p1.lon], [p2.lat, p2.lon], [lat, p2.lon], [lat, p1.lon]
        ], { color, weight: 1, opacity: 0.8, fillColor: color, fillOpacity: 0.25 }).addTo(map));
      }
      
      tempLayers.push(L.polyline(points.map(p => [p.lat, p.lon]), {
        color: '#fafafa', weight: 1.5, opacity: 0.6
      }).addTo(map));
      
      points.forEach(p => {
        if (p.temp === null) return;
        const arrow = p.diff > 0 ? '‚Üë' : p.diff < 0 ? '‚Üì' : '';
        const displayDiff = useFahrenheit ? Math.round(p.diff * 1.8) : Math.round(p.diff);
        const diffText = p.diff === 0 ? '' : ` ${arrow}${Math.abs(displayDiff)}`;
        const isWarm = p.diff > 0;
        
        const label = L.divIcon({
          className: 'temp-label',
          html: `<span style="color:${isWarm ? '#ff3b30' : '#3b82f6'};font-size:10px;font-weight:500;background:rgba(10,10,11,0.7);padding:1px 4px;border-radius:3px">${formatTemp(p.temp, false)}¬∞${diffText}</span>`,
          iconSize: [50, 18],
          iconAnchor: [25, isWarm ? -4 : 20]
        });
        tempLayers.push(L.marker([lat, p.lon], { icon: label }).addTo(map));
      });
    }
    
    async function setLocation(newLat, lon, panTo = false) {
      lat = Math.max(-85, Math.min(85, newLat));
      if (panTo) map.setView([lat, lon], Z);
      
      if (line) map.removeLayer(line);
      line = L.polyline([[lat,-1800],[lat,1800]], { color:'#888', weight:2, opacity:0.5 }).addTo(map);
      
      marker ? marker.setLatLng([lat, lon]) : marker = L.marker([lat, lon], { icon }).addTo(map);
      updateCoords();
      history.replaceState(null, '', `?lat=${lat.toFixed(2)}&lon=${lon.toFixed(2)}`);
      
      document.getElementById('loading').style.display = 'block';
      const temps = await fetchTemperatures(lat, lon);
      document.getElementById('loading').style.display = 'none';
      drawTemperatureLine(lat, temps, lon);
    }
    
    document.getElementById('set').onclick = () => {
      const center = map.getCenter();
      setLocation(center.lat, center.lng);
    };
    
    document.getElementById('loc').onclick = () => 
      navigator.geolocation.getCurrentPosition(p => setLocation(p.coords.latitude, p.coords.longitude, true));
    
    document.getElementById('unit').onclick = () => {
      useFahrenheit = !useFahrenheit;
      document.getElementById('unit').textContent = useFahrenheit ? '¬∞F' : '¬∞C';
      if (lastTempData) drawTemperatureLine(lat, lastTempData, lastUserLon);
    };
    
    const params = new URLSearchParams(location.search);
    setLocation(parseFloat(params.get('lat')) || 52.52, parseFloat(params.get('lon')) || 13.4, true);
  </script>
</body>
</html>
